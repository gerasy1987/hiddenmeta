---
title: "hiddenmeta workflow"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{hiddenmeta workflow}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

```


## Install and load packages

```{r install, eval=FALSE}

install.packages("DeclareDesign")
install.packages("igraph")

devtools::install_github("gerasy1987/hiddenmeta", build_vignettes = TRUE)

```

```{r setup}

library(hiddenmeta)
library(DeclareDesign)
library(igraph)

```

## Step 1. Provide study design features

```{r example_designs}

## STUDY 1
study_1 <- 
  list(
    # total population size for one study
    N = 2000,
    # number of groups
    # (K-th group is hidden population we are interested in)
    K = 2,
    # probability of membership in each of the groups (prev_K[K] is the true prevalence)
    prev_K = c(known = .3, hidden = .1),
    # correlation matrix of group memberships
    rho_K = .05,
    
    # block edge probabilities depending on group memberships
    # 1 - list of in- and out-group probability of links for each group
    # 2 - probability of link between in- and out-group members
    p_edge_within = list(known = c(0.05, 0.05), hidden = c(0.05, 0.9)),
    p_edge_between = list(known = 0.05, hidden = 0.01),
    
    # probability of visibility (show-up) for each group
    p_visibility = list(known = .99, hidden = .7),
    
    # probability of service utilization in hidden population
    # for service multiplier
    add_groups = list(service_use = 0.3, 
                      loc_1 = 0.3, loc_2 = 0.1, loc_3 = 0.2, 
                      known_2 = 0.1, known_3 = 0.2),
    
    # RDS parameters
    n_seed = 20,
    n_coupons = 3,
    target_type = "sample",
    target_n_rds = 100,
    
    # prop sampling parameters
    target_n_pps = 400,
    
    # TLS sampling parameters
    target_n_tls = 1
  )

```

## Step 2. Declare study population



```{r example_pop, eval=TRUE}

population_study <-
  do.call(what = declare_population,
          args = c(handler = get_study_population, study_1[1:8]))

set.seed(19872312)
( example_pop <- population_study() )

```

### Show the network

```{r plot_pop_network, fig.width=6, fig.height=8}

g <-
  example_pop %$% {
    igraph::graph_from_adj_list(links,
                                mode = "all") %>%
      igraph::set_vertex_attr("name", value = name) %>%
      igraph::set_vertex_attr("type", value = type)
  }

igraph::V(g)$color <-
  plyr::mapvalues(igraph::V(g)$type,
                  from = unique(igraph::V(g)$type),
                  to = grDevices::palette.colors(n = length(unique(igraph::V(g)$type)), palette = "Set 3"))

plot(g,
     layout = igraph::layout_on_grid(g, dim = 2, width = 100),
     vertex.size = 3, vertex.dist = 2, vertex.label = NA, edge.width = 1,
     edge.arrow.size = .2, edge.curved = .2)

legend(x = -1, y = -1.2,
       legend = c("none", "known only", "hidden only", "both"),
       pt.bg = grDevices::palette.colors(n = length(unique(igraph::V(g)$type)), palette = "Set 3"),
       pch = 21, col = "#777777", pt.cex = 2, cex = 1.5, bty = "o", ncol = 2)

```

## Step 3. Declare all relevant study sampling procedures

The sampling procedures are additive in a sense that each procedure appends several columns relevant to the sampling procedure and particular draw based on population simulation, but does not change the study population data frame (unless you specify `drop_nonsampled = TRUE`).

```{r example_rds}
rds_study <- 
  do.call(declare_sampling,
          c(handler = sample_rds, 
            sampling_variable = "rds",
            drop_nonsampled = FALSE, study_1[9:12]))

set.seed(19872312)
draw_data(population_study + 
            rds_study)
```

```{r example_pps}
pps_study <- 
  do.call(declare_sampling,
          c(handler = sample_pps, 
            sampling_variable = "pps",
            drop_nonsampled = FALSE, study_1[13]))

set.seed(19872312)
draw_data(population_study + 
            rds_study + pps_study)
```

```{r example_tls}
tls_study <- 
  do.call(declare_sampling,
          c(handler = sample_tls, 
            sampling_variable = "tls",
            drop_nonsampled = FALSE, study_1[14]))

set.seed(19872312)
draw_data(population_study + 
            rds_study + pps_study + tls_study)
```


## Step 4. Declare study level estimands

```{r example_estimands, eval=TRUE}
study_estimands <- 
  declare_estimand(handler = get_study_estimands)

set.seed(19872312)
draw_estimands(population_study + 
                 rds_study + pps_study + tls_study + 
                 study_estimands)
```


## Step 5. Declare estimators used in the study

```{r example_estimators, eval=TRUE}
estimator_sspse <- declare_estimator(handler = get_study_est_sspse, label = "sspse")
estimator_ht <- declare_estimator(handler = get_study_est_ht, label = "ht")
estimator_chords <- declare_estimator(type = "integrated",
                                      handler = get_study_est_chords, label = "chords")
estimator_nsum <- declare_estimator(handler = get_study_est_nsum, label = "nsum")

set.seed(19872312)
draw_estimates(population_study +
                 rds_study + pps_study + tls_study +
                 study_estimands +
                 estimator_sspse + estimator_ht + estimator_chords + estimator_nsum)
```


## Step 6. Diagnose study design

```{r example_diagnose, eval=TRUE}
study_diagnosands <-
  declare_diagnosands(
    mean_estimand = mean(estimand),
    mean_estimate = mean(estimate),
    sd_estimate = sd(estimate),
    mean_se = mean(se),
    bias = mean(estimate - estimand),
    rmse = sqrt(mean((estimate - estimand) ^ 2))
  )

diagnose_design(
  population_study + 
    rds_study + pps_study + 
    study_estimands + 
    estimator_sspse + estimator_ht + estimator_chords + estimator_nsum, 
  diagnosands = study_diagnosands,
  sims = 10,
  bootstrap_sims = 10)
```

# Meta-analysis

```{r meta_study, eval=FALSE}

pop_args <- 
  list(study_1 = study_1,
       study_2 = study_2)


population_meta <- 
  declare_population(
    handler = get_meta_population, 
    pop_args = pop_args
  )

population_meta()

hpop_rds <- 
  declare_sampling(
    handler = get_hpop_sample, 
    sampling_variable = "rds",
    drop_nonsampled = FALSE,
    sampling_args = pop_args,
    sampling_strategy = "sample_rds") 

hpop_rds(population_meta())

pop_pps <- 
  declare_sampling(
    handler = get_hpop_sample, 
    sampling_variable = "prop",
    drop_nonsampled = FALSE,
    sampling_args = pop_args,
    sampling_strategy = "sample_pps") 

set.seed(19872312)
# hpop_rds(population())
# pop_prop(population())

draw_data(population + hpop_rds + pop_prop)

study_estimands <- 
  declare_estimand(handler = get_hpop_estimands)

# get_hpop_estimands(draw_data(population + hpop_rds + pop_prop))

draw_estimands(population + hpop_rds + pop_prop + study_estimands)


```
