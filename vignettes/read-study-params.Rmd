---
title: "Reading study parameters with hiddenmeta"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Reading study parameters with hiddenmeta}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = TRUE,
  echo = TRUE,
  fig.path = "vignette-",
  message = FALSE,
  warning = FALSE
)

library(magrittr)
library(knitr)

```

## Load packages

```{r setup}

library(hiddenmeta)
library(DeclareDesign)

seed <- 871223

study_diagnosands <-
 declare_diagnosands(
    mean_estimand = mean(estimand),
    mean_estimate = mean(estimate),
    sd_estimate = sd(estimate),
    mean_se = mean(se),
    bias = mean(estimate - estimand),
    rmse = sqrt(mean((estimate - estimand) ^ 2))
  )

```

## Read study designs

- The Google spreadsheet with the current study designs can be found [here](https://docs.google.com/spreadsheets/d/1HwMM6JwoGALLMTpC8pQRVzaQdD2X71jpZNhfpKTnF8Y/edit?usp=sharing) (access restricted)
- Currently only spreadsheets of the format presented at the link are supported
- To load the spreadsheet you need to provide authentication e-mail and when reading the parameters you will be asked to log in into your Google account
- In addition the function currently allows to specify spreadsheet ID and specific sheet name within the spreadsheet to use for reading

```{r read, eval=FALSE}

googlesheets4::gs4_auth(email = "gerasy@gmail.com")

study_df <- 
  read_gs(
    ss = "1HwMM6JwoGALLMTpC8pQRVzaQdD2X71jpZNhfpKTnF8Y",
    sheet = "study_params_readable"
  )

study_designs <- 
  read_populations(study_df) %>% 
  read_samples(study_df, append_list = .) %>% 
  read_inquiries(study_df, append_list = .) %>% 
  read_estimators(study_df, append_list = .)

```

```{r save, eval=FALSE, echo=FALSE}

saveRDS(study_designs, file = here::here("inst/extdata/study_designs.rds"))

```

```{r read_study_designs, eval=TRUE, echo=FALSE}

study_designs <- 
  readRDS(system.file("extdata", "study_designs.rds", package = "hiddenmeta"))

```

## Declare all studies together

```{r declare_studies, eval=FALSE}

multi_population <- 
  declare_population(handler = get_multi_populations, 
                     study_designs = study_designs)

multi_sampling <- 
  declare_sampling(handler = get_multi_samples,
                   study_designs = study_designs) 

multi_inquiry <- 
  declare_inquiry(handler = get_multi_estimands, 
                  study_designs = study_designs) 

multi_estimators <-
  declare_estimator(handler = get_multi_estimates,
                    study_designs = study_designs)

multi_study <- multi_population + multi_sampling + multi_inquiry + multi_estimators

set.seed(seed)
diagnose_design(multi_study, sims = 1,
                diagnosands = study_diagnosands) %>%
  reshape_diagnosis %>% select(-'Design') %>%
  kable()

set.seed(seed)
multi_study_data <- draw_data(multi_study)


saveRDS(multi_study_data, file = here::here("inst/extdata/multi_sim_data_draw.rds"))


```

## Generate required data

```{r required_data}

multi_study_data <- 
  readRDS(system.file("extdata", "multi_sim_data_draw.rds", package = "hiddenmeta"))

( data_require_base <- get_required_data(multi_study_data) )

```
