---
title: "Reading study parameters with hiddenmeta"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Reading study parameters with hiddenmeta}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = TRUE,
  echo = TRUE,
  fig.path = "vignette-",
  message = FALSE,
  warning = FALSE
)

```

## Load packages

```{r setup}

library(hiddenmeta)
library(DeclareDesign)
library(knitr)

```

## Read study designs

- The Google spreadsheet with the current study designs can be found [here](https://docs.google.com/spreadsheets/d/1HwMM6JwoGALLMTpC8pQRVzaQdD2X71jpZNhfpKTnF8Y/edit?usp=sharing) (access restricted)
- Currently only spreadsheets of the format presented at the link are supported
- To load the spreadsheet you need to provide authentication e-mail and when reading the parameters you will be asked to log in into your Google account
- In addition the function currently allows to specify spreadsheet ID and specific sheet name within the spreadsheet to use for reading

```{r read, eval=FALSE}

googlesheets4::gs4_auth(email = "gerasy@gmail.com")

study_designs <- 
  read_study_params(
    ss = "1HwMM6JwoGALLMTpC8pQRVzaQdD2X71jpZNhfpKTnF8Y",
    sheet = "study_params_readable"
  )

save(study_designs, file = "study_designs.rdata")

```

```{r read_study_designs, eval=TRUE}

load(file = "study_designs.rdata")

study_diagnosands <-
 declare_diagnosands(
    mean_estimand = mean(estimand),
    mean_estimate = mean(estimate),
    sd_estimate = sd(estimate),
    mean_se = mean(se),
    bias = mean(estimate - estimand),
    rmse = sqrt(mean((estimate - estimand) ^ 2))
  )

```

## Declare studies separately

```{r ff_brazil, eval=FALSE}

design <- study_designs$ff_brazil

study_population <-
  eval(as.call(c(list(declare_population), design$pop)))

study_sample_rds <- 
  eval(as.call(c(list(declare_sampling), design$samples$rds)))

study_sample_pps <-
  eval(as.call(c(list(declare_sampling), design$samples$pps)))

# study_sample_tls <- 
#   eval(as.call(c(list(declare_sampling), design$samples$tls)))

study_estimands <- 
  eval(as.call(c(list(declare_inquiry), design$inquiries)))

est_sspse <- 
  eval(as.call(c(list(declare_estimator), design$estimators$rds$sspse)))
est_chords <- 
  eval(as.call(c(list(declare_estimator), design$estimators$rds$chords)))
est_multi <- 
  eval(as.call(c(list(declare_estimator), design$estimators$rds$multiplier)))

est_ht_pps <- 
  eval(as.call(c(list(declare_estimator), design$estimators$pps$ht)))
est_nsum_pps <- 
  eval(as.call(c(list(declare_estimator), design$estimators$pps$nsum)))

est_recap_rds_pps <- 
  eval(as.call(c(list(declare_estimator), design$estimators$rds_pps$recap1)))

# est_ht_tls <- 
#   eval(as.call(c(list(declare_estimator), design$estimators$tls$ht)))
# est_nsum_tls <- 
#   eval(as.call(c(list(declare_estimator), design$estimators$tls$nsum)))
# est_recap_tls <- 
#   eval(as.call(c(list(declare_estimator), design$estimators$tls$recap)))

study <- 
  study_population +
                 study_sample_rds + 
                 study_sample_pps + 
                 # study_sample_tls +
                 study_estimands +
                 est_sspse +
                 est_chords +
                 est_multi +
                 est_nsum_pps +
                 est_ht_pps +
                 # est_nsum_tls + 
                 # est_ht_tls + 
                 # est_recap_tls +
                 est_recap_rds_pps #+
                 # est_recap_rds_tls

set.seed(872312)
diagnose_design(study, sims = 1, 
                diagnosands = study_diagnosands) %>% 
  reshape_diagnosis %>% select(-'Design') %>%
  kable()

```

```{r umass_tunisia, eval=FALSE}

design <- study_designs$umass_tunisia

study_population <-
  eval(as.call(c(list(declare_population), design$pop)))

study_sample_tls <- 
  eval(as.call(c(list(declare_sampling), design$samples$tls)))

study_estimands <- 
  eval(as.call(c(list(declare_inquiry), design$inquiries)))

est_ht_tls <- 
  eval(as.call(c(list(declare_estimator), design$estimators$tls$ht)))
est_nsum_tls <- 
  eval(as.call(c(list(declare_estimator), design$estimators$tls$nsum)))
est_recap_tls <- 
  eval(as.call(c(list(declare_estimator), design$estimators$tls$recap)))

study <- 
  study_population + study_sample_tls + study_estimands + 
  est_nsum_tls + est_ht_tls + est_recap_tls

set.seed(872312)
diagnose_design(study, sims = 1, 
                diagnosands = study_diagnosands) %>% 
  reshape_diagnosis %>% select(-'Design') %>%
  kable()

```

```{r stanford_brazil, eval=FALSE}

design <- study_designs$stanford_brazil

study_population <-
  eval(as.call(c(list(declare_population), design$pop)))

study_sample_pps <-
  eval(as.call(c(list(declare_sampling), design$samples$pps)))

study_estimands <- 
  eval(as.call(c(list(declare_inquiry), design$inquiries)))

est_ht_pps <- 
  eval(as.call(c(list(declare_estimator), design$estimators$pps$ht)))
est_nsum_pps <- 
  eval(as.call(c(list(declare_estimator), design$estimators$pps$nsum)))

study <- 
  study_population + study_sample_pps +  study_estimands + 
  est_nsum_pps + est_ht_pps

set.seed(872312)
diagnose_design(study, sims = 1, 
                diagnosands = study_diagnosands) %>% 
  reshape_diagnosis %>% select(-'Design') %>%
  kable()

```

```{r jhu_pakistan, eval=FALSE}

design <- study_designs$jhu_pakistan

study_population <-
  eval(as.call(c(list(declare_population), design$pop)))

study_sample_rds <- 
  eval(as.call(c(list(declare_sampling), design$samples$rds)))
study_sample_pps <-
  eval(as.call(c(list(declare_sampling), design$samples$pps)))


study_estimands <- 
  eval(as.call(c(list(declare_inquiry), design$inquiries)))

est_sspse <- 
  eval(as.call(c(list(declare_estimator), design$estimators$rds$sspse)))
# est_chords <-
#   eval(as.call(c(list(declare_estimator), design$estimators$rds$chords)))

est_ht_pps <- 
  eval(as.call(c(list(declare_estimator), design$estimators$pps$ht)))
est_nsum_pps <- 
  eval(as.call(c(list(declare_estimator), design$estimators$pps$nsum)))

est_recap_rds_pps <- 
  eval(as.call(c(list(declare_estimator), design$estimators$rds_pps$recap1)))

study <- 
  study_population + study_sample_rds +  study_sample_pps +  study_estimands + 
  est_sspse + est_nsum_pps + est_ht_pps + est_recap_rds_pps #+ est_chords 

set.seed(872312)
diagnose_design(study, sims = 1, 
                diagnosands = study_diagnosands) %>% 
  reshape_diagnosis %>% select(-'Design') %>%
  kable()

```

```{r johnjay_costarica, eval=FALSE}

design <- study_designs$johnjay_costarica

study_population <-
  eval(as.call(c(list(declare_population), design$pop)))

study_sample_rds <- 
  eval(as.call(c(list(declare_sampling), design$samples$rds)))
study_sample_pps <-
  eval(as.call(c(list(declare_sampling), design$samples$pps)))


study_estimands <- 
  eval(as.call(c(list(declare_inquiry), design$inquiries)))

est_sspse <- 
  eval(as.call(c(list(declare_estimator), design$estimators$rds$sspse)))
# est_chords <- 
#   eval(as.call(c(list(declare_estimator), design$estimators$rds$chords)))

est_ht_pps <- 
  eval(as.call(c(list(declare_estimator), design$estimators$pps$ht)))
est_nsum_pps <- 
  eval(as.call(c(list(declare_estimator), design$estimators$pps$nsum)))

est_recap_rds_pps <- 
  eval(as.call(c(list(declare_estimator), design$estimators$rds_pps$recap1)))

study <- 
  study_population + study_sample_rds +  study_sample_pps +  study_estimands + 
  est_sspse + est_nsum_pps + est_ht_pps + est_recap_rds_pps # + est_chords

set.seed(872312)
diagnose_design(study, sims = 1, 
                diagnosands = study_diagnosands) %>% 
  reshape_diagnosis %>% select(-'Design') %>%
  kable()

```

```{r johnjay_tanzania, eval=FALSE}

design <- study_designs$johnjay_tanzania

study_population <-
  eval(as.call(c(list(declare_population), design$pop)))

study_sample_rds <- 
  eval(as.call(c(list(declare_sampling), design$samples$rds)))
study_sample_pps <-
  eval(as.call(c(list(declare_sampling), design$samples$pps)))


study_estimands <- 
  eval(as.call(c(list(declare_inquiry), design$inquiries)))

est_sspse <- 
  eval(as.call(c(list(declare_estimator), design$estimators$rds$sspse)))
est_chords <- 
  eval(as.call(c(list(declare_estimator), design$estimators$rds$chords)))

est_ht_pps <- 
  eval(as.call(c(list(declare_estimator), design$estimators$pps$ht)))
est_nsum_pps <- 
  eval(as.call(c(list(declare_estimator), design$estimators$pps$nsum)))

est_recap_rds_pps <- 
  eval(as.call(c(list(declare_estimator), design$estimators$rds_pps$recap1)))

study <- 
  study_population + study_sample_rds +  study_sample_pps +  study_estimands + 
  est_sspse + est_chords + est_nsum_pps + est_ht_pps + est_recap_rds_pps

set.seed(872312)
diagnose_design(study, sims = 1, 
                diagnosands = study_diagnosands) %>% 
  reshape_diagnosis %>% select(-'Design') %>%
  kable()

```

```{r norc_marocco, eval=FALSE}

design <- study_designs$norc_marocco

study_population <-
  eval(as.call(c(list(declare_population), design$pop)))

study_sample_rds <- 
  eval(as.call(c(list(declare_sampling), design$samples$rds)))
study_sample_tls <-
  eval(as.call(c(list(declare_sampling), design$samples$tls)))

study_estimands <- 
  eval(as.call(c(list(declare_inquiry), design$inquiries)))

est_sspse <- 
  eval(as.call(c(list(declare_estimator), design$estimators$rds$sspse)))
est_chords <- 
  eval(as.call(c(list(declare_estimator), design$estimators$rds$chords)))

est_ht_tls <-
  eval(as.call(c(list(declare_estimator), design$estimators$tls$ht)))
est_nsum_tls <-
  eval(as.call(c(list(declare_estimator), design$estimators$tls$nsum)))
est_recap_tls <-
  eval(as.call(c(list(declare_estimator), design$estimators$tls$recap)))

est_recap_rds_tls <-
  eval(as.call(c(list(declare_estimator), design$estimators$rds_tls$recap2)))

study <- 
  study_population + study_sample_rds +  study_sample_tls + study_estimands + 
  est_sspse + est_nsum_tls + est_ht_tls + est_recap_tls + est_recap_rds_tls + est_chords

set.seed(872312)
diagnose_design(study, sims = 1, 
                diagnosands = study_diagnosands) %>% 
  reshape_diagnosis %>% select(-'Design') %>%
  kable()

```


```{r rti_usa, eval=FALSE}

design <- study_designs$rti_usa

study_population <-
  eval(as.call(c(list(declare_population), design$pop)))

study_sample_rds <- 
  eval(as.call(c(list(declare_sampling), design$samples$rds)))
study_sample_tls <-
  eval(as.call(c(list(declare_sampling), design$samples$tls)))

study_estimands <- 
  eval(as.call(c(list(declare_inquiry), design$inquiries)))

est_sspse <- 
  eval(as.call(c(list(declare_estimator), design$estimators$rds$sspse)))
est_chords <- 
  eval(as.call(c(list(declare_estimator), design$estimators$rds$chords)))

est_ht_tls <-
  eval(as.call(c(list(declare_estimator), design$estimators$tls$ht)))
est_nsum_tls <-
  eval(as.call(c(list(declare_estimator), design$estimators$tls$nsum)))
est_recap_tls <-
  eval(as.call(c(list(declare_estimator), design$estimators$tls$recap)))

est_recap_rds_tls <-
  eval(as.call(c(list(declare_estimator), design$estimators$rds_tls$recap2)))

study <- 
  study_population + study_sample_rds +  study_sample_tls + study_estimands + 
  est_sspse + est_nsum_tls + est_ht_tls + est_recap_tls + est_recap_rds_tls #+ est_chords

set.seed(872312)
diagnose_design(study, sims = 1, 
                diagnosands = study_diagnosands) %>% 
  reshape_diagnosis %>% select(-'Design') %>%
  kable()

```

## Declare all studies together

```{r declare_studies, eval=FALSE}

multi_population <- 
  declare_population(handler = get_multi_populations, 
                     pops_args = sapply(study_designs, 
                                        function(x) x$pop, 
                                        simplify = FALSE))

multi_sampling <- 
  declare_sampling(handler = get_multi_samples,
                   samples_args = sapply(study_designs, 
                                        function(x) x$samples, 
                                        simplify = FALSE)) 

multi_inquiry <- 
  declare_inquiry(handler = get_multi_estimands, 
                  inquiries_args = sapply(study_designs, 
                                        function(x) x$inquiries, 
                                        simplify = FALSE)) 

multi_estimators <-
  declare_estimator(handler = get_multi_estimates,
                    estimators_args = sapply(study_designs, 
                                             function(x) x$estimators, 
                                             simplify = FALSE))

multi_study <- multi_population + multi_sampling + multi_inquiry + multi_estimators

set.seed(872312)
diagnose_design(multi_study, sims = 1, 
                diagnosands = study_diagnosands) %>% 
  reshape_diagnosis %>% select(-'Design') %>%
  kable()

```
