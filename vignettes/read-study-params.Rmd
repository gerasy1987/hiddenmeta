---
title: "Reading study parameters with hiddenmeta"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Reading study parameters with hiddenmeta}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
   collapse = TRUE,
   comment = "#>",
   eval = TRUE,
   echo = TRUE,
   fig.path = "vignette-",
   message = FALSE,
   warning = FALSE
)

library(magrittr)
library(knitr)
library(pbapply)
library(ggplot2)

```

## Load packages

```{r setup}
library(hiddenmeta)
library(DeclareDesign)

study_diagnosands <-
   declare_diagnosands(
      mean_estimand = mean(estimand),
      mean_estimate = mean(estimate),
      sd_estimate = sd(estimate),
      mean_se = mean(se),
      bias = mean(estimate - estimand),
      rmse = sqrt(mean((estimate - estimand)^2))
   )
```

## Read study designs

- The Google spreadsheet with the current study designs can be found [here](https://docs.google.com/spreadsheets/d/1HwMM6JwoGALLMTpC8pQRVzaQdD2X71jpZNhfpKTnF8Y/edit?usp=sharing) (access restricted)
- Currently only spreadsheets of the format presented at the link are supported
- To load the spreadsheet you need to provide authentication e-mail and when reading the parameters you will be asked to log in into your Google account
- In addition the function currently allows to specify spreadsheet ID and specific sheet name within the spreadsheet to use for reading

```{r read, eval=FALSE}
study_df <-
   read_gs(
      ss = "1x-OO6dGLWFENXdeDN2Gskd382ch1sNM1HDavPs_K-IM",
      sheet = "sims1"
   )

study_designs <-
   read_populations(study_df) %>%
   read_samples(study_df, append_list = .) %>%
   read_inquiries(study_df, append_list = .) %>%
   read_estimators(study_df, append_list = .)
```

```{r save, eval=FALSE, echo=FALSE}
saveRDS(study_designs, file = here::here("inst/extdata/study_designs.rds"))
```

```{r read_study_designs, eval=TRUE, echo=FALSE}
study_designs <-
   readRDS(system.file("extdata", "study_designs.rds", package = "hiddenmeta"))
```

## Declare all studies together

```{r declare_studies, eval=TRUE, echo=TRUE}
multi_population <-
   declare_population(
      handler = get_multi_populations,
      study_designs = study_designs
   )

multi_sampling <-
   declare_sampling(
      handler = get_multi_samples,
      study_designs = study_designs
   )

multi_inquiry <-
   declare_inquiry(
      handler = get_multi_estimands,
      study_designs = study_designs
   )

multi_estimators <-
   declare_estimator(
      handler = get_multi_estimates,
      study_designs = study_designs
   )

multi_study <- multi_population + multi_sampling + multi_inquiry + multi_estimators

# diagnose_design(multi_study, sims = 1)

```

```{r run_sims, eval=FALSE, echo=TRUE}

set.seed(871223)

multi_simulations <-
   pbapply::pblapply(
      X = 1:50,
      FUN = function(x) {
         base::suppressWarnings(
            DeclareDesign::simulate_design(multi_study, sims = 1) |>
               dplyr::mutate(sim_ID = x)
         )
      },
      cl = 5
   )

multi_simulations <- do.call(rbind, 
                             args = c(multi_simulations, make.row.names = FALSE))

saveRDS(multi_simulations, file = here::here("inst/extdata/multi_sim_studies.rds"))

# gc(verbose = TRUE)
# mallinfo::malloc.trim()

```

## Generate required data

```{r required_data, eval=FALSE}

data <- 
   readRDS(system.file("extdata", "multi_sim_studies.rds", package = "hiddenmeta")) |>
   # multi_simulations |>
   dplyr::filter(!is.na(estimate)) |> 
   dplyr::mutate(
      bias = estimate/estimand,
      study = stringr::str_match(inquiry, "^(.+?_.+?)_")[,2],
      study_estimand = stringr::str_match(inquiry, ".*_([^_]+_[^_]+)$")[,2],
      study_estimator = gsub(paste0(unique(study_estimand), "_", collapse = "|"), "", estimator)
   ) |> 
   dplyr::group_by(sim_ID, study, study_estimand) |> 
   dplyr::mutate(
      rel_bias = log(bias/bias[grep(pattern = "ht", study_estimator)])
   ) |> 
   dplyr::ungroup()

# data |> 
#    dplyr::filter(sim_ID == 1) |> 
#    dplyr::select(inquiry, estimator, bias) |> 
#    print(n = 32)

data |> 
   ggplot(aes(x = study_estimator, y = rel_bias, fill = study_estimator)) +
   geom_boxplot(notch = TRUE, notchwidth = .8, outlier.shape = NA) +
   geom_jitter(size = .7, alpha = .3, width = .2) +
   facet_wrap(~ study, scales = "free_y", ncol = 2) +
   coord_flip() +
   theme_minimal() +
   labs(title = "Relative bias of sampling-estimator strategies",
        x = "Sampling-estimator strategies",
        y = "Log(Absolute relative bias)") +
  theme(legend.position = "none")

data <- 
   readRDS(system.file("extdata", "multi_sim_studies.rds", package = "hiddenmeta")) |>
   # multi_simulations |>
   dplyr::filter(!is.na(estimate)) |> 
   dplyr::mutate(
      bias = estimate/estimand,
      study = stringr::str_match(inquiry, "^(.+?_.+?)_")[,2],
      study_estimand = stringr::str_match(inquiry, ".*_([^_]+_[^_]+)$")[,2],
      study_estimator = gsub(paste0(unique(study_estimand), "_", collapse = "|"), "", estimator)
   ) |> 
   dplyr::group_by(sim_ID, study_estimand) |> 
   dplyr::mutate(
      rel_bias = log(bias/median(bias[grep(pattern = "pps_ht", study_estimator)]))
   ) |> 
   dplyr::ungroup()

data |> 
   ggplot(aes(x = study_estimator, y = rel_bias, fill = study_estimator)) +
   geom_boxplot(notch = TRUE, notchwidth = .8, outlier.shape = NA) +
   geom_jitter(size = .7, alpha = .3, width = .2) +
   # facet_wrap(~ study, scales = "free_y", ncol = 2) +
   coord_flip() +
   theme_minimal() +
   labs(title = "Relative bias of sampling-estimator strategies",
        x = "Sampling-estimator strategies",
        y = "Log(Absolute relative bias)") +
  theme(legend.position = "none")

```
