---
title: "Reading study parameters with hiddenmeta"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Reading study parameters with hiddenmeta}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = TRUE,
  echo = TRUE,
  fig.path = "vignette-",
  message = FALSE,
  warning = FALSE
)

```

## Load packages

```{r setup}

library(hiddenmeta)
library(DeclareDesign)
library(knitr)

```

## Read study designs

- The Google spreadsheet with the current study designs can be found [here](https://docs.google.com/spreadsheets/d/1HwMM6JwoGALLMTpC8pQRVzaQdD2X71jpZNhfpKTnF8Y/edit?usp=sharing) (access restricted)
- Currently only spreadsheets of the format presented at the link are supported
- To load the spreadsheet you need to provide authentication e-mail and when reading the parameters you will be asked to log in into your Google account
- In addition the function currently allows to specify spreadsheet ID and specific sheet name within the spreadsheet to use for reading

```{r read, eval=FALSE}

study_designs <- 
  read_study_params(
    auth_email = "gerasy@gmail.com",
    ss = "1HwMM6JwoGALLMTpC8pQRVzaQdD2X71jpZNhfpKTnF8Y",
    sheet = "study_params_readable"
  )

save(study_designs, file = "vignettes/study_designs.rdata")

```

```{r read_study_designs, eval=TRUE}

load(file = "vignettes/study_designs.rdata")

```

## Declare multiple studies

```{r declare_studies, eval=FALSE}

multi_population <- 
  declare_population(handler = get_multi_populations, 
                     pops_args = sapply(study_designs[1], 
                                        function(x) x$pop, 
                                        simplify = FALSE))

multi_sampling <- 
  declare_sampling(handler = get_multi_samples, 
                   samples_args = sapply(study_designs[1], 
                                        function(x) x$samples, 
                                        simplify = FALSE)) 

multi_inquiry <- 
  declare_inquiry(handler = get_multi_estimands, 
                  inquiries_args = sapply(study_designs[1], 
                                        function(x) x$inquiries, 
                                        simplify = FALSE)) 

multi_estimators <-
  declare_estimator(handler = get_multi_estimates,
                    estimators_args = sapply(study_designs[1], 
                                             function(x) x$estimators, 
                                             simplify = FALSE))

multi_study <- multi_population + multi_sampling + multi_inquiry + multi_estimators

set.seed(872312)
draw_data(multi_study)

set.seed(872312)
draw_estimands(multi_study) %>%
  kable()

draw_estimates(multi_study) %>%
  kable()


```
